<template>
  <div
    v-if="total > perPage"
    class="is-align-self-flex-end is-flex is-justify-content-flex-end">
    <NeoPagination
      :total="total"
      :current.sync="current"
      :range-before="3"
      :range-after="3"
      :simple="simple"
      :per-page="perPage"
      tag="a"
      aria-next-label="Next page"
      aria-previous-label="Previous page"
      aria-page-label="Page"
      aria-current-label="Current page"
      @change="onPageChange" />
    <NeoTooltip :label="$t('tooltip.random') + ' (g+r)'" position="left">
      <NeoButton
        v-if="hasMagicBtn"
        class="ml-2 no-shadow"
        :title="$t('tooltip.random')"
        icon-left="dice"
        @click.native="goToRandomPage">
      </NeoButton>
    </NeoTooltip>
  </div>
</template>

<script setup lang="ts">
import { getRandomIntInRange } from '../utils'
import { NeoButton, NeoPagination, NeoTooltip } from '@kodadot1/brick'

const props = withDefaults(
  defineProps<{
    value: number
    total: number
    perPage?: number
    simple: boolean
    replace: boolean
    preserveScroll?: boolean
    hasMagicBtn: boolean
    enableListenKeyboardEvent?: boolean
  }>(),
  {
    perPage: 20,
  }
)
const emit = defineEmits(['input'])

const current = computed({
  get: () => props.value,
  set: (value: number) => {
    emit('input', value)
    replaceUrl(String(value))
  },
})

const scrollTop = () => {
  window.scrollTo({
    top: 0,
    behavior: 'smooth',
  })
}

const onPageChange = () => {
  if (!props.preserveScroll) {
    scrollTop()
  }
}

const goToRandomPage = () => {
  onPageChange()
  const pageSize = Math.ceil(props.total / props.perPage)
  let randomNumber = getRandomIntInRange(1, pageSize)
  current.value = randomNumber
}

const replaceUrl = (value: string, key = 'page') => {
  const { $route, $router, $consola } = useNuxtApp()
  if ($route.query[key] !== value) {
    $router
      .replace({
        path: String($route.path),
        query: { ...$route.query, [key]: value },
      })
      .catch($consola.warn /*Navigation Duplicate err fix later */)
  }
}
</script>
